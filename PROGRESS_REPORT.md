# ESP32 IoT 센서 제어 시스템 - 중간 보고서

## 📋 프로젝트 개요

ESP32 기반 IoT 센서 제어 시스템으로, 온습도 센서 데이터를 수집하고 MQTT를 통해 실시간 전송하며, 웹서버와 Node.js 서버를 통해 제어 및 데이터 로깅을 제공하는 시스템입니다.

**개발 기간**: 2024년 (진행 중)  
**주요 기술**: ESP-IDF, MQTT, Node.js, MongoDB, HTTP Web Server

---

## ✅ 완료된 기능

### 1. 센서 하드웨어 지원
- ✅ **RGB LED** (GPIO 4, 5, 6)
  - 빨강/초록/파랑 색상 제어
  - 웹서버 제어 가능
- ✅ **DHT11 온습도 센서** (GPIO 7)
  - 실시간 온도/습도 읽기 (2초 주기)
  - 데이터 검증 및 재시도 로직
- ✅ **부저** (GPIO 8)
  - ON/OFF 제어
  - 웹서버 제어 가능

### 2. 웹서버 기능
- ✅ **실시간 센서 데이터 표시**
  - 현재 온도/습도 표시 (2초마다 자동 업데이트)
  - 5분 평균 온도/습도 표시
- ✅ **RGB LED 제어**
  - 빨강/초록/파랑/끄기 버튼
- ✅ **부저 제어**
  - ON/OFF 버튼
- ✅ **RESTful API**
  - `GET /sensor` - 센서 데이터 조회
  - `POST /rgb_led` - RGB LED 제어
  - `POST /buzzer` - 부저 제어

### 3. MQTT 통신
- ✅ **센서 데이터 발행**
  - 토픽: `esp32/sensor`
  - 형식: JSON (deviceId, temperature, humidity, timestamp, valid)
  - 주기: 2초마다 자동 발행
- ✅ **상태 메시지**
  - 토픽: `esp32/status`
  - 연결 상태 및 LED 상태 전송

### 4. Node.js 서버 (데이터 로깅)
- ✅ **MQTT 구독**
  - `esp32/sensor` 토픽 구독
  - 실시간 데이터 수신
- ✅ **MongoDB 저장**
  - 온도/습도 데이터 자동 저장
  - 타임스탬프, 장치 ID 포함
- ✅ **HTTP API 제공**
  - `GET /api/sensors/data` - 센서 데이터 조회
  - `GET /api/sensors/statistics` - 통계 데이터 조회
  - `GET /api/system/info` - 시스템 정보

### 5. 데이터 처리
- ✅ **실시간 평균 계산**
  - 최근 5분간 데이터 버퍼링
  - 실시간 평균 온도/습도 계산

---

## 🌐 두 가지 웹서버

### ESP32 웹서버 (http://172.30.1.63)
**역할**: 실시간 센서 제어 및 모니터링
- 위치: ESP32 하드웨어 내부
- 포트: 80
- 기능: RGB LED/부저 제어, 실시간 온습도 표시
- 데이터: 임시 저장 (5분 평균만 메모리에)
- 접근: WiFi 네트워크 내 모든 기기

### Node.js 서버 (localhost:3002)
**역할**: 데이터 로깅 및 관리 (개발자용)
- 위치: PC (로컬 컴퓨터)
- 포트: 3002
- 기능: MongoDB 저장, 데이터 조회, 통계 분석
- 데이터: 영구 저장 (모든 히스토리)
- 접근: PC에서만 (localhost)

**차이점 요약**: 
- ESP32 웹서버 = 현장 제어판 (실시간 제어 + 현재 상태)
- Node.js 서버 = 데이터 센터 (모든 기록 저장 + 분석)

자세한 비교는 `SERVER_COMPARISON.md` 참고

---

## 🏗️ 시스템 아키텍처

```
┌─────────────┐
│    ESP32    │
│             │
│  ┌────────┐ │
│  │ DHT11  │─┼──→ 센서 읽기 (2초)
│  └────────┘ │
│      │      │
│      ▼      │
│  ┌────────┐ │
│  │ MQTT   │─┼──→ esp32/sensor 발행
│  └────────┘ │
│      │      │
│      ▼      │
│  ┌────────┐ │
│  │ HTTP   │─┼──→ 웹서버 (포트 80)
│  └────────┘ │
└──────┬──────┘
       │
       ├─────────────┬─────────────────┐
       │             │                 │
       ▼             ▼                 ▼
┌──────────┐  ┌──────────┐    ┌──────────────┐
│  MQTT    │  │ 브라우저 │    │  라즈베리파이 │
│  Broker  │  │ (웹 UI)  │    │  QT 클라이언트│
└────┬─────┘  └──────────┘    └──────────────┘
     │
     ▼
┌──────────────┐
│ Node.js 서버 │
│              │
│  ┌─────────┐ │
│  │ MQTT    │─┼──→ 구독 및 수신
│  └─────────┘ │
│      │       │
│      ▼       │
│  ┌─────────┐ │
│  │ MongoDB │─┼──→ 데이터 저장
│  └─────────┘ │
│      │       │
│      ▼       │
│  ┌─────────┐ │
│  │ HTTP API│─┼──→ 로그 조회
│  └─────────┘ │
└──────────────┘
```

---

## 📊 테스트 결과

### 1. 하드웨어 테스트
- ✅ RGB LED: 빨강/초록/파랑 색상 정상 동작
- ✅ DHT11: 온도 25.3-25.4°C, 습도 47% 정상 측정
- ✅ 부저: ON/OFF 제어 정상 동작

### 2. MQTT 통신 테스트
- ✅ ESP32 → MQTT Broker: 정상 발행
- ✅ Node.js 서버 → MQTT Broker: 정상 구독
- ✅ 메시지 수신 주기: 약 2초마다 정상 수신

### 3. 데이터 저장 테스트
- ✅ MongoDB 연결: 정상
- ✅ 데이터 저장: 온도/습도 데이터 정상 저장
- ✅ 데이터 조회: API를 통한 조회 정상 동작

### 4. 웹서버 테스트
- ✅ 웹페이지 접속: 정상
- ✅ 센서 데이터 표시: 실시간 업데이트 정상
- ✅ RGB LED 제어: 정상 동작
- ✅ 부저 제어: 정상 동작

---

## 📸 필요한 캡처 자료

### 1. ESP32 시리얼 모니터 캡처
**캡처 위치**: ESP-IDF 시리얼 모니터

**캡처할 내용**:
- [ ] 초기화 완료 로그 (IP 주소, MQTT 연결)
- [ ] 센서 데이터 발행 로그 (2-3개 예시)
  ```
  I (xxxx) main: 🌡️  온도: 25.4°C, 💧 습도: 47%
  I (xxxx) main: 📡 MQTT 센서 데이터 발행: {"deviceId":"esp32-001",...}
  ```

### 2. Node.js 서버 로그 캡처
**캡처 위치**: PowerShell/터미널 (서버 실행 창)

**캡처할 내용**:
- [ ] 서버 시작 로그 (MongoDB, MQTT 연결)
- [ ] 센서 데이터 수신 및 저장 로그 (5-10개 예시)
  ```
  📨 MQTT 메시지 수신 [esp32/sensor]: {...}
  📊 센서 데이터 저장 완료: { deviceId: 'esp32-001', ... }
  ```

### 3. MQTT Explorer 화면 캡처
**캡처 위치**: MQTT Explorer 애플리케이션

**캡처할 내용**:
- [ ] 연결 설정 화면 (broker.hivemq.com:1883)
- [ ] `esp32/sensor` 토픽 구독 화면
- [ ] 수신된 메시지 목록 (2-3개 예시)

### 4. 웹서버 화면 캡처
**캡처 위치**: 웹 브라우저

**캡처할 내용**:
- [ ] 메인 페이지 (온습도 표시)
  - 실시간 온도/습도 값
  - 5분 평균 값
- [ ] RGB LED 제어 버튼
- [ ] 부저 제어 버튼

### 5. HTTP API 응답 캡처
**캡처 위치**: PowerShell (curl 명령 실행 결과)

**캡처할 내용**:
- [ ] `/api/system/info` 응답
- [ ] `/api/sensors/data?limit=5` 응답
- [ ] `/api/sensors/statistics?days=7` 응답

### 6. MongoDB 데이터 캡처 (선택)
**캡처 위치**: MongoDB Compass 또는 Shell

**캡처할 내용**:
- [ ] 저장된 센서 데이터 목록 (3-5개)
- [ ] 데이터 개수 (countDocuments)

---

## 🔧 기술 스택

### ESP32 펌웨어
- **프레임워크**: ESP-IDF (v5.x)
- **언어**: C
- **주요 라이브러리**: 
  - FreeRTOS
  - ESP HTTP Server
  - ESP MQTT Client
  - GPIO Driver

### 서버 사이드
- **런타임**: Node.js v18.16.1
- **프레임워크**: Express.js
- **데이터베이스**: MongoDB
- **통신**: MQTT (mqtt.js)

### 통신 프로토콜
- **MQTT**: broker.hivemq.com:1883
- **HTTP**: RESTful API

---

## 📁 프로젝트 구조

```
project-mqtt/
├── main/
│   ├── app_main.c              # 메인 애플리케이션
│   ├── web_server.c            # HTTP 웹서버
│   ├── mqtt_manager.c          # MQTT 클라이언트
│   ├── wifi_manager.c          # WiFi 관리
│   ├── rgb_led_control.c       # RGB LED 제어
│   ├── dht11_sensor.c          # DHT11 센서 드라이버
│   ├── buzzer_control.c        # 부저 제어
│   └── sensor_average.c        # 평균 계산
├── esp32-server/
│   ├── server.js               # Node.js 서버
│   ├── services/
│   │   └── database.js         # MongoDB 서비스
│   └── models/
│       └── index.js            # 데이터 모델
├── ARCHITECTURE_FLOW.md        # 아키텍처 문서
├── TEST_GUIDE.md               # 테스트 가이드
└── PROGRESS_REPORT.md          # 이 보고서
```

---

## 🎯 다음 단계 (향후 계획)

### Phase 1: 라즈베리파이 QT 클라이언트 개발
- [ ] Qt MQTT 클라이언트 구현
- [ ] `esp32/sensor` 토픽 구독
- [ ] 실시간 데이터 표시 UI
- [ ] 차트/그래프 표시

### Phase 2: 추가 기능
- [ ] 다중 ESP32 장치 지원
- [ ] 데이터 시각화 (Grafana 등)
- [ ] 알람 기능 (임계값 초과 시)
- [ ] 모바일 앱 연동

### Phase 3: 최적화
- [ ] 데이터 압축
- [ ] 에너지 효율 최적화
- [ ] 안정성 개선

---

## 📊 현재 통계

- **센서 데이터 수집**: ✅ 정상 작동 중
- **데이터 발행 주기**: 약 2초
- **MQTT 메시지**: 정상 수신 중
- **MongoDB 저장**: 정상 저장 중
- **HTTP API**: 정상 응답 중

---

## 📝 요약

현재까지 ESP32 기반 센서 제어 시스템의 핵심 기능이 모두 구현되었습니다. MQTT를 통한 실시간 데이터 전송과 MongoDB를 통한 데이터 로깅이 정상적으로 작동하고 있으며, 웹서버를 통한 센서 제어와 데이터 표시도 완료되었습니다.

다음 단계로 라즈베리파이 QT 클라이언트 개발과 추가 기능 구현이 필요합니다.

---

**작성일**: 2024년  
**작성자**: 개발 팀  
**버전**: 1.0 (중간 보고서)

